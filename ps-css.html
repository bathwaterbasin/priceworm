<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Sentiment Indicator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .score-display {
            font-size: 4rem;
            font-weight: bold;
            text-align: center;
            padding: 2rem;
            border-radius: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1f2937 !important;
        }
        .tab-button {
            transition: all 0.2s ease;
        }
        .tab-button.active {
            background: rgba(99, 102, 241, 0.3);
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="glass rounded-xl p-6 mb-6">
            <h1 class="text-4xl font-bold text-gray-800 text-center mb-2">Bitcoin Sentiment Indicator</h1>
            <p class="text-gray-700 text-center opacity-90">Multi-Factor Macro Analysis</p>
        </div>

        <!-- Tabs -->
        <div class="glass rounded-xl mb-6 p-2 flex gap-2">
            <button onclick="switchTab('dashboard')" id="dashboardTab" class="tab-button active flex-1 py-3 px-6 rounded-lg text-gray-800 font-semibold">Dashboard</button>
            <button onclick="switchTab('learn')" id="learnTab" class="tab-button flex-1 py-3 px-6 rounded-lg text-gray-800 font-semibold">Learn More</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardContent">
            <!-- Score Display -->
            <div class="glass rounded-xl p-6 mb-6">
                <div id="scoreDisplay" class="score-display">--</div>
                <p class="text-gray-800 text-center text-xl mt-4 font-semibold" id="scoreLabel">Enter values to calculate</p>
            </div>

            <!-- Input Fields -->
            <div class="glass rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Current Metrics</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="text-gray-800 font-semibold block mb-2">Federal Funds Rate (%)</label>
                        <input type="number" id="fedRate" step="0.01" value="4.25" class="w-full p-3 rounded-lg bg-white bg-opacity-50 text-gray-800 placeholder-gray-500 border border-gray-300" oninput="updateScores()">
                    </div>
                    <div>
                        <label class="text-gray-800 font-semibold block mb-2">QQQ Nasdaq-100</label>
                        <input type="number" id="qqq" step="1" value="590" class="w-full p-3 rounded-lg bg-white bg-opacity-50 text-gray-800 placeholder-gray-500 border border-gray-300" oninput="updateScores()">
                    </div>
                    <div>
                        <label class="text-gray-800 font-semibold block mb-2">LTH Supply (%)</label>
                        <input type="number" id="lth" step="0.1" value="59.5" class="w-full p-3 rounded-lg bg-white bg-opacity-50 text-gray-800 placeholder-gray-500 border border-gray-300" oninput="updateScores()">
                    </div>
                    <div>
                        <label class="text-gray-800 font-semibold block mb-2">DXY Dollar Index</label>
                        <input type="number" id="dxy" step="0.1" value="98.8" class="w-full p-3 rounded-lg bg-white bg-opacity-50 text-gray-800 placeholder-gray-500 border border-gray-300" oninput="updateScores()">
                    </div>
                    <div>
                        <label class="text-gray-800 font-semibold block mb-2">HY Credit Spreads (bps)</label>
                        <input type="number" id="spread" step="1" value="284" class="w-full p-3 rounded-lg bg-white bg-opacity-50 text-gray-800 placeholder-gray-500 border border-gray-300" oninput="updateScores()">
                    </div>
                    <div>
                        <label class="text-gray-800 font-semibold block mb-2">24h Liquidations ($M)</label>
                        <input type="number" id="liqAmount" step="1" value="19000" class="w-full p-3 rounded-lg bg-white bg-opacity-50 text-gray-800 placeholder-gray-500 border border-gray-300 mb-2" oninput="updateScores()">
                        <select id="liqType" class="w-full p-3 rounded-lg bg-white bg-opacity-50 text-gray-800 border border-gray-300" onchange="updateScores()">
                            <option value="shorts">Shorts Liquidated</option>
                            <option value="mixed">Mixed</option>
                            <option value="longs" selected>Longs Liquidated</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- CSV Upload -->
            <div class="glass rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Historical Data</h2>
                <div class="flex flex-wrap gap-4 items-center">
                    <input type="file" id="csvUpload" accept=".csv" class="text-gray-800" onchange="handleCSVUpload(event)">
                    <button onclick="loadDefaultData()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition">Load Default Data</button>
                </div>
                <div id="dataStatus" class="text-gray-700 mt-4"></div>
            </div>

            <!-- Data Context & Warnings -->
            <div class="glass rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Current Data Context (October 12, 2025)</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-4">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                            <h3 class="font-bold text-blue-900 mb-2">‚úÖ Real-Time Metrics</h3>
                            <ul class="text-sm text-blue-800 space-y-1">
                                <li><strong>Bitcoin:</strong> $111,800 (live price, recovering from crash)</li>
                                <li><strong>Fed Funds Rate:</strong> 4.25% (cut Sept 17, official)</li>
                                <li><strong>QQQ:</strong> $590 (Friday close, down from $610)</li>
                                <li><strong>DXY:</strong> 98.8 (Friday close, down from recent highs)</li>
                                <li><strong>LTH Supply:</strong> 59.5% (on-chain data, stable)</li>
                            </ul>
                        </div>

                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                            <h3 class="font-bold text-red-900 mb-2">‚ö†Ô∏è Historic Liquidation Event</h3>
                            <p class="text-sm text-red-800 mb-2">
                                <strong>October 10-11, 2025:</strong> Trump's 100% China tariff threat triggered the largest crypto liquidation in history.
                            </p>
                            <ul class="text-sm text-red-800 space-y-1">
                                <li><strong>Total Liquidated:</strong> $19+ billion (mostly longs)</li>
                                <li><strong>BTC Drop:</strong> $126k ‚Üí $101k (20% crash)</li>
                                <li><strong>Comparison:</strong> 20x larger than COVID crash ($1.2B)</li>
                                <li><strong>Impact:</strong> 1.6M+ traders liquidated globally</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-4">
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                            <h3 class="font-bold text-yellow-900 mb-2">‚è≥ Delayed Data - Credit Spreads</h3>
                            <p class="text-sm text-yellow-800 mb-2">
                                <strong>Current Display:</strong> 284 bps (as of Oct 8, Wed close)
                            </p>
                            <p class="text-sm text-yellow-800 mb-2">
                                <strong>Why It's Outdated:</strong> FRED and ICE BofA update spreads with 1-2 day delay. Friday's massive selloff data won't be available until Monday/Tuesday.
                            </p>
                            <p class="text-sm text-yellow-800 mb-2">
                                <strong>Expected Reality:</strong> Based on April 2025 tariff event (when spreads jumped 119 bps), current spreads likely widened to 350-450+ bps.
                            </p>
                            <p class="text-sm text-yellow-800 font-semibold">
                                ‚ö†Ô∏è Check back Monday for official updated spreads from FRED/ICE BofA
                            </p>
                        </div>

                        <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                            <h3 class="font-bold text-purple-900 mb-2">üìà Sentiment Score Impact</h3>
                            <p class="text-sm text-purple-800 mb-2">
                                The current composite score uses pre-Friday data for credit spreads, meaning it may be artificially elevated.
                            </p>
                            <p class="text-sm text-purple-800 mb-2">
                                <strong>If spreads widened to 400 bps:</strong> HY Score drops from 99 ‚Üí 87, lowering composite by ~1.2 points.
                            </p>
                            <p class="text-sm text-purple-800 font-semibold">
                                The massive liquidations already heavily impact the sentiment score (5% weight).
                            </p>
                        </div>

                        <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                            <h3 class="font-bold text-green-900 mb-2">üîÑ How to Update</h3>
                            <p class="text-sm text-green-800">
                                Monitor <strong>FRED series BAMLH0A0HYM2</strong> starting Monday. When official post-Friday spreads are published, update the "HY Credit Spreads" input field above.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 bg-gray-100 border border-gray-300 p-4 rounded">
                    <p class="text-sm text-gray-700">
                        <strong>Summary:</strong> The indicator currently uses the best available data as of Sunday, Oct 12. Five metrics are real-time accurate, but credit spreads reflect Wednesday's close (284 bps) and likely widened significantly on Friday. This creates a ~1-2 point potential variance in the final composite score until official spread data updates.
                    </p>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="glass rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Date Range</h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="filterByYear('all')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">All</button>
                    <button onclick="filterByYear(2020)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">2020</button>
                    <button onclick="filterByYear(2021)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">2021</button>
                    <button onclick="filterByYear(2022)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">2022</button>
                    <button onclick="filterByYear(2023)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">2023</button>
                    <button onclick="filterByYear(2024)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">2024</button>
                    <button onclick="filterByYear(2025)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">2025</button>
                </div>
            </div>

            <!-- Charts -->
            <div class="glass rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Metric Breakdown</h2>
                <div style="height: 300px;">
                    <canvas id="metricChart"></canvas>
                </div>
            </div>

            <div class="glass rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Historical Sentiment</h2>
                <div style="height: 400px;">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>

            <div class="glass rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">BTC Price vs Sentiment</h2>
                <div id="correlationDisplay" class="text-gray-800 text-center mb-4 text-lg font-semibold"></div>
                <div style="height: 400px;">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Learn More Tab -->
        <div id="learnContent" style="display: none;">
            <div class="glass rounded-xl p-6 mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Understanding the Metrics</h2>
                
                <div class="space-y-6 text-gray-800">
                    <div class="bg-white bg-opacity-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-2xl font-bold mb-3">1. Federal Funds Rate (30% weight)</h3>
                        <p class="mb-3">The most influential factor in our model. Lower interest rates make Bitcoin more attractive as an alternative asset. When the Fed cuts rates, it reduces the opportunity cost of holding non-yielding assets like Bitcoin and typically increases liquidity in the system.</p>
                        <p class="font-semibold mb-2">Historical Examples:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>March 2020: 1.25% rate ‚Üí Score 77 (emergency cuts during COVID)</li>
                            <li>November 2021: 0.25% rate ‚Üí Score 95 (peak liquidity, BTC hit $69k)</li>
                            <li>October 2025: 4.50% rate ‚Üí Score 18 (restrictive policy)</li>
                        </ul>
                    </div>

                    <div class="bg-white bg-opacity-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-2xl font-bold mb-3">2. QQQ Nasdaq-100 (20% weight)</h3>
                        <p class="mb-3">Technology stocks and Bitcoin often move together as "risk-on" assets. A higher QQQ indicates stronger risk appetite in the market, which historically correlates with Bitcoin strength. Tech investors and crypto investors share similar risk profiles.</p>
                        <p class="font-semibold mb-2">Historical Examples:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>March 2020: 180 ‚Üí Score 0 (market panic, BTC at $4,800)</li>
                            <li>November 2021: 398 ‚Üí Score 50 (tech rally, BTC at $69k)</li>
                            <li>October 2025: 610 ‚Üí Score 98 (strong tech performance)</li>
                        </ul>
                    </div>

                    <div class="bg-white bg-opacity-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-2xl font-bold mb-3">3. Long-Term Holder Supply (20% weight) - BELL CURVE</h3>
                        <p class="mb-3">This on-chain metric shows the percentage of Bitcoin held by long-term investors (coins unmoved for 155+ days). The optimal range is 59-63%. Too low indicates capitulation and weak hands, while too high suggests distribution tops with no new buyers entering.</p>
                        <p class="font-semibold mb-2">Historical Examples:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>March 2020: 62% ‚Üí Score 100 (ideal conviction during bottom)</li>
                            <li>November 2021: 56% ‚Üí Score 25 (distribution phase at top)</li>
                            <li>October 2025: 59.5% ‚Üí Score 100 (healthy accumulation)</li>
                        </ul>
                    </div>

                    <div class="bg-white bg-opacity-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-2xl font-bold mb-3">4. DXY Dollar Index (15% weight)</h3>
                        <p class="mb-3">A weaker dollar makes Bitcoin more attractive globally. When the dollar weakens, it benefits international buyers and reflects lower confidence in traditional fiat currency. Bitcoin often acts as a hedge against dollar weakness.</p>
                        <p class="font-semibold mb-2">Historical Examples:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>November 2021: 95.1 ‚Üí Score 77 (weak dollar, BTC rally)</li>
                            <li>June 2022: 105.2 ‚Üí Score 38 (strong dollar, BTC bottom)</li>
                            <li>October 2025: 100.3 ‚Üí Score 57 (moderate dollar strength)</li>
                        </ul>
                    </div>

                    <div class="bg-white bg-opacity-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-2xl font-bold mb-3">5. High Yield Credit Spreads (10% weight)</h3>
                        <p class="mb-3">Measures financial stress and risk appetite. Credit spreads represent the extra yield investors demand to hold corporate bonds over treasuries. Wider spreads indicate fear and risk-off sentiment, while tighter spreads show confidence and risk-on conditions.</p>
                        <p class="font-semibold mb-2">Historical Examples:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>March 2020: 900 bps ‚Üí Score 25 (peak financial stress)</li>
                            <li>November 2021: 305 bps ‚Üí Score 99 (calm markets)</li>
                            <li>October 2025: 305 bps ‚Üí Score 99 (stable conditions)</li>
                        </ul>
                    </div>

                    <div class="bg-white bg-opacity-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-2xl font-bold mb-3">6. 24-Hour Liquidations (5% weight) - DYNAMIC</h3>
                        <p class="mb-3">This metric uses both magnitude AND type of liquidations. Short liquidations are bullish (bears forced out), while long liquidations at market tops serve as warning signals. Moderate spikes ($300-600M) represent healthy leverage clearing, while extreme events (over $1,200M) indicate panic.</p>
                        <p class="font-semibold mb-2">Key Historical Events:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>August 2024: $1,080M longs liquidated ‚Üí Score ~22 (Japan carry trade unwind)</li>
                            <li>November 2024: $427M shorts liquidated ‚Üí Score 100+ (healthy Trump rally)</li>
                            <li>December 2024: $1,520M longs liquidated ‚Üí Score ~12 (flash crash near top)</li>
                            <li>September 2025: $1,680M longs liquidated ‚Üí Score ~10 (largest 2025 event)</li>
                        </ul>
                        <p class="mt-3">The scoring adjusts based on liquidation type: shorts liquidated get a 1.2x multiplier (bullish), mixed stays neutral, and longs liquidated receive penalties (0.7x for moderate amounts, 0.5x for large amounts over $400M).</p>
                    </div>

                    <div class="bg-white bg-opacity-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-2xl font-bold mb-3">Composite Score Interpretation</h3>
                        <p class="mb-3">The final score combines all six metrics with their respective weights to provide a holistic view of macro conditions:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>80-100 (Excellent):</strong> Multiple tailwinds aligned, historically strong buying conditions</li>
                            <li><strong>60-79 (Good):</strong> Favorable conditions with minor headwinds</li>
                            <li><strong>40-59 (Neutral):</strong> Mixed signals, market in transition</li>
                            <li><strong>20-39 (Poor):</strong> Multiple headwinds, caution warranted</li>
                            <li><strong>0-19 (Terrible):</strong> Severely negative conditions, historically near bottoms or tops</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
                            <li>June 2022: 105.2 ‚Üí Score 38 (strong dollar, BTC bottom)</li>
                            <li>October 2025: 100.3 ‚Üí Score 57 (moderate dollar strength)</li>
                        </ul>
                    </div>

                    <div class="bg-white bg-opacity-10 p-6 rounded-lg">
                        <h3 class="text-2xl font-bold mb-3">5. High Yield Credit Spreads (10% weight)</h3>
                        <p class="mb-3 opacity-90">Measures financial stress and risk appetite. Credit spreads represent the extra yield investors demand to hold corporate bonds over treasuries. Wider spreads indicate fear and risk-off sentiment, while tighter spreads show confidence and risk-on conditions.</p>
                        <p class="font-semibold mb-2">Historical Examples:</p>
                        <ul class="list-disc list-inside space-y-1 opacity-90">
                            <li>March 2020: 900 bps ‚Üí Score 25 (peak financial stress)</li>
                            <li>November 2021: 305 bps ‚Üí Score 99 (calm markets)</li>
                            <li>October 2025: 305 bps ‚Üí Score 99 (stable conditions)</li>
                        </ul>
                    </div>

                    <div class="bg-white bg-opacity-10 p-6 rounded-lg">
                        <h3 class="text-2xl font-bold mb-3">6. 24-Hour Liquidations (5% weight) - DYNAMIC</h3>
                        <p class="mb-3 opacity-90">This metric uses both magnitude AND type of liquidations. Short liquidations are bullish (bears forced out), while long liquidations at market tops serve as warning signals. Moderate spikes ($300-600M) represent healthy leverage clearing, while extreme events (over $1,200M) indicate panic.</p>
                        <p class="font-semibold mb-2">Key Historical Events:</p>
                        <ul class="list-disc list-inside space-y-1 opacity-90">
                            <li>August 2024: $1,080M longs liquidated ‚Üí Score ~22 (Japan carry trade unwind)</li>
                            <li>November 2024: $427M shorts liquidated ‚Üí Score 100+ (healthy Trump rally)</li>
                            <li>December 2024: $1,520M longs liquidated ‚Üí Score ~12 (flash crash near top)</li>
                            <li>September 2025: $1,680M longs liquidated ‚Üí Score ~10 (largest 2025 event)</li>
                        </ul>
                        <p class="mt-3 opacity-90">The scoring adjusts based on liquidation type: shorts liquidated get a 1.2x multiplier (bullish), mixed stays neutral, and longs liquidated receive penalties (0.7x for moderate amounts, 0.5x for large amounts over $400M).</p>
                    </div>

                    <div class="bg-white bg-opacity-10 p-6 rounded-lg">
                        <h3 class="text-2xl font-bold mb-3">Composite Score Interpretation</h3>
                        <p class="mb-3 opacity-90">The final score combines all six metrics with their respective weights to provide a holistic view of macro conditions:</p>
                        <ul class="list-disc list-inside space-y-1 opacity-90">
                            <li><strong>80-100 (Excellent):</strong> Multiple tailwinds aligned, historically strong buying conditions</li>
                            <li><strong>60-79 (Good):</strong> Favorable conditions with minor headwinds</li>
                            <li><strong>40-59 (Neutral):</strong> Mixed signals, market in transition</li>
                            <li><strong>20-39 (Poor):</strong> Multiple headwinds, caution warranted</li>
                            <li><strong>0-19 (Terrible):</strong> Severely negative conditions, historically near bottoms or tops</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var historicalData = [];
        var filteredData = [];
        var charts = {
            metric: null,
            sentiment: null,
            price: null
        };
        var updateTimeout = null;

        // Default CSV data
        var defaultCSV = `date,btc,fed,dxy,spread,liqAmount,liqType,lth,qqq
2020-03,4800,1.25,99.5,900,600,longs,62,180
2020-04,7000,0.25,99.8,800,120,mixed,63,200
2020-05,9500,0.25,99.2,700,80,mixed,63,230
2020-06,9200,0.25,97.4,650,90,mixed,64,245
2020-07,11000,0.25,93.5,600,110,mixed,64,265
2020-08,11700,0.25,92.8,550,95,mixed,64,285
2020-09,10800,0.25,94.2,530,130,longs,65,270
2020-10,13500,0.25,93.1,500,180,shorts,65,290
2020-11,18500,0.25,91.8,450,220,shorts,64,305
2020-12,28900,0.25,89.9,400,280,shorts,62,315
2021-01,33000,0.25,90.2,380,310,shorts,60,330
2021-02,45000,0.25,90.8,360,380,shorts,58,335
2021-03,58800,0.25,92.8,350,420,shorts,57,325
2021-04,57700,0.25,91.0,340,280,mixed,56,340
2021-05,37300,0.25,89.9,330,650,longs,58,335
2021-06,35000,0.25,91.9,340,340,longs,60,355
2021-07,41500,0.25,92.7,330,210,shorts,61,370
2021-08,47100,0.25,92.7,320,240,shorts,62,380
2021-09,43800,0.25,94.2,325,380,longs,63,360
2021-10,61300,0.25,93.9,310,290,shorts,60,385
2021-11,69000,0.25,95.1,305,320,shorts,56,398
2021-12,47200,0.25,96.0,320,520,longs,58,395
2022-01,38000,0.25,96.4,350,420,longs,60,355
2022-02,43200,0.25,96.7,360,280,mixed,61,345
2022-03,45500,0.50,98.3,380,190,mixed,62,365
2022-04,37600,0.75,103.0,420,380,longs,63,310
2022-05,31800,1.00,101.8,480,480,longs,64,295
2022-06,17600,1.75,105.2,580,730,longs,65,275
2022-07,23300,2.50,106.4,560,340,shorts,66,300
2022-08,20000,2.50,108.5,550,290,longs,66,315
2022-09,19400,3.25,112.2,600,350,longs,66,275
2022-10,20500,3.25,111.8,580,260,mixed,66,280
2022-11,17200,4.00,106.9,550,850,longs,66,295
2022-12,16500,4.50,103.5,520,320,longs,65,270
2023-01,23100,4.75,101.7,480,240,shorts,65,310
2023-02,23400,4.75,104.0,470,180,mixed,65,305
2023-03,28500,5.00,102.9,450,420,shorts,64,320
2023-04,29200,5.25,101.8,440,170,mixed,64,335
2023-05,27200,5.25,104.2,460,210,longs,64,330
2023-06,30400,5.25,103.0,445,190,mixed,64,365
2023-07,29800,5.50,101.2,430,160,mixed,63,380
2023-08,26100,5.50,103.7,450,270,longs,63,370
2023-09,26900,5.50,106.0,470,230,longs,63,360
2023-10,34500,5.50,106.7,460,280,shorts,62,365
2023-11,37700,5.50,104.1,430,310,shorts,62,395
2023-12,42300,5.50,101.4,400,340,shorts,61,415
2024-01,43100,5.50,103.2,390,210,mixed,60,430
2024-02,51900,5.50,104.3,380,290,shorts,59,445
2024-03,70700,5.50,104.0,360,380,shorts,58,465
2024-04,63500,5.50,105.8,375,310,longs,59,445
2024-05,68800,5.50,104.7,365,240,mixed,59,475
2024-06,61200,5.50,105.9,380,270,longs,60,485
2024-07,66500,5.50,104.4,370,320,shorts,60,500
2024-08,59700,5.50,103.0,385,1080,longs,60,490
2024-09,63800,5.00,100.8,360,210,shorts,60,510
2024-10,69300,5.00,103.9,350,285,shorts,60,515
2024-11,97400,4.75,106.5,330,427,shorts,59,540
2024-12,95600,4.50,107.8,325,1520,longs,59,565
2025-01,102800,4.50,108.3,320,320,shorts,59,580
2025-02,98500,4.50,106.2,325,280,longs,59.5,570
2025-03,85300,4.50,104.1,340,380,longs,60,545
2025-04,91200,4.50,102.7,330,240,shorts,60,560
2025-05,98700,4.50,101.5,320,290,shorts,60,575
2025-06,93400,4.50,105.3,335,320,longs,60,555
2025-07,101500,4.50,103.8,318,270,shorts,59.5,590
2025-08,97600,4.50,102.1,325,550,longs,59.5,580
2025-09,104200,4.50,100.9,312,1680,longs,59.5,600
2025-10,111800,4.25,98.8,284,19000,longs,59.5,590`;

        // Calculation functions
        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        function calculateFedScore(rate) {
            return clamp(100 - (rate * 18.18), 0, 100);
        }

        function calculateQQQScore(qqq) {
            return clamp((qqq - 180) / 4.4, 0, 100);
        }

        function calculateLTHScore(lth) {
            var score;
            if (lth < 59) {
                score = 25 + ((lth - 56) * 25);
            } else if (lth >= 59 && lth < 63) {
                score = 100;
            } else {
                score = 100 - ((lth - 63) * 12.5);
            }
            return clamp(score, 0, 100);
        }

        function calculateDXYScore(dxy) {
            return clamp(100 - ((dxy - 89) * 3.846), 0, 100);
        }

        function calculateHYScore(spread) {
            return clamp(100 - ((spread - 300) * 0.125), 0, 100);
        }

        function calculateLiqScore(amount, type) {
            var base;
            if (amount < 100) {
                base = 50;
            } else if (amount >= 100 && amount < 300) {
                base = 50 + ((amount - 100) / 4);
            } else if (amount >= 300 && amount < 600) {
                base = 100;
            } else if (amount >= 600 && amount < 1200) {
                base = 100 - ((amount - 600) / 12);
            } else {
                base = Math.max(10, 50 - ((amount - 1200) / 30));
            }

            var score;
            if (type === 'shorts') {
                score = base * 1.2;
            } else if (type === 'mixed') {
                score = base;
            } else {
                if (amount > 400) {
                    score = base * 0.5;
                } else {
                    score = base * 0.7;
                }
            }
            return clamp(score, 0, 100);
        }

        function calculateComposite(fed, qqq, lth, dxy, spread, liqAmount, liqType) {
            var fedScore = calculateFedScore(fed);
            var qqqScore = calculateQQQScore(qqq);
            var lthScore = calculateLTHScore(lth);
            var dxyScore = calculateDXYScore(dxy);
            var hyScore = calculateHYScore(spread);
            var liqScore = calculateLiqScore(liqAmount, liqType);

            var composite = (fedScore * 0.30) + (qqqScore * 0.20) + (lthScore * 0.20) + 
                          (dxyScore * 0.15) + (hyScore * 0.10) + (liqScore * 0.05);
            
            return {
                composite: clamp(composite, 0, 100),
                fed: fedScore,
                qqq: qqqScore,
                lth: lthScore,
                dxy: dxyScore,
                hy: hyScore,
                liq: liqScore
            };
        }

        function getScoreColor(score) {
            if (score >= 80) return '#10b981';
            if (score >= 60) return '#3b82f6';
            if (score >= 40) return '#fbbf24';
            if (score >= 20) return '#fb923c';
            return '#ef4444';
        }

        function getScoreLabel(score) {
            if (score >= 80) return 'Excellent';
            if (score >= 60) return 'Good';
            if (score >= 40) return 'Neutral';
            if (score >= 20) return 'Poor';
            return 'Terrible';
        }

        function updateScores() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(function() {
                var fed = parseFloat(document.getElementById('fedRate').value);
                var qqq = parseFloat(document.getElementById('qqq').value);
                var lth = parseFloat(document.getElementById('lth').value);
                var dxy = parseFloat(document.getElementById('dxy').value);
                var spread = parseFloat(document.getElementById('spread').value);
                var liqAmount = parseFloat(document.getElementById('liqAmount').value);
                var liqType = document.getElementById('liqType').value;

                var scores = calculateComposite(fed, qqq, lth, dxy, spread, liqAmount, liqType);
                
                var scoreDisplay = document.getElementById('scoreDisplay');
                var scoreValue = Math.round(scores.composite);
                scoreDisplay.textContent = scoreValue;
                scoreDisplay.style.color = getScoreColor(scores.composite);
                
                document.getElementById('scoreLabel').textContent = getScoreLabel(scores.composite);

                updateMetricChart(scores);
            }, 300);
        }

        function updateMetricChart(scores) {
            var ctx = document.getElementById('metricChart').getContext('2d');
            
            if (charts.metric) {
                charts.metric.destroy();
            }

            charts.metric = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Fed Rate (30%)', 'QQQ (20%)', 'LTH Supply (20%)', 'DXY (15%)', 'HY Spreads (10%)', 'Liquidations (5%)'],
                    datasets: [{
                        label: 'Score',
                        data: [scores.fed, scores.qqq, scores.lth, scores.dxy, scores.hy, scores.liq],
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ],
                        borderColor: 'rgba(255, 255, 255, 0.5)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function switchTab(tab) {
            var dashboardTab = document.getElementById('dashboardTab');
            var learnTab = document.getElementById('learnTab');
            var dashboardContent = document.getElementById('dashboardContent');
            var learnContent = document.getElementById('learnContent');

            if (tab === 'dashboard') {
                dashboardTab.classList.add('active');
                learnTab.classList.remove('active');
                dashboardContent.style.display = 'block';
                learnContent.style.display = 'none';
            } else {
                dashboardTab.classList.remove('active');
                learnTab.classList.add('active');
                dashboardContent.style.display = 'none';
                learnContent.style.display = 'block';
            }
        }

        function handleCSVUpload(event) {
            var file = event.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var csvContent = e.target.result;
                    parseCSVData(csvContent);
                };
                reader.readAsText(file);
            }
        }

        function loadDefaultData() {
            parseCSVData(defaultCSV);
        }

        function parseCSVData(csvContent) {
            var parsed = Papa.parse(csvContent, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                transformHeader: function(header) {
                    return header.trim();
                }
            });

            if (parsed.errors.length > 0) {
                document.getElementById('dataStatus').textContent = 'Error parsing CSV: ' + parsed.errors[0].message;
                return;
            }

            historicalData = parsed.data.map(function(row) {
                var scores = calculateComposite(row.fed, row.qqq, row.lth, row.dxy, row.spread, row.liqAmount, row.liqType);
                return {
                    date: row.date,
                    btc: row.btc,
                    sentiment: scores.composite
                };
            });

            filteredData = historicalData;
            document.getElementById('dataStatus').textContent = 'Loaded ' + historicalData.length + ' data points';
            updateCharts();
        }

        function filterByYear(year) {
            if (year === 'all') {
                filteredData = historicalData;
            } else {
                filteredData = historicalData.filter(function(item) {
                    return item.date.startsWith(year.toString());
                });
            }
            updateCharts();
        }

        function calculateCorrelation(x, y) {
            var n = x.length;
            if (n === 0 || n !== y.length) return 0;

            var sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
            for (var i = 0; i < n; i++) {
                sumX += x[i];
                sumY += y[i];
                sumXY += x[i] * y[i];
                sumX2 += x[i] * x[i];
                sumY2 += y[i] * y[i];
            }

            var numerator = (n * sumXY) - (sumX * sumY);
            var denominator = Math.sqrt(((n * sumX2) - (sumX * sumX)) * ((n * sumY2) - (sumY * sumY)));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }

        function updateCharts() {
            if (filteredData.length === 0) return;

            var dates = filteredData.map(function(d) { return d.date; });
            var sentiments = filteredData.map(function(d) { return d.sentiment; });
            var prices = filteredData.map(function(d) { return d.btc; });

            // Calculate correlation
            var correlation = calculateCorrelation(prices, sentiments);
            document.getElementById('correlationDisplay').textContent = 
                'Correlation Coefficient: ' + correlation.toFixed(3) + 
                (correlation > 0.5 ? ' (Strong Positive)' : correlation > 0 ? ' (Positive)' : correlation > -0.5 ? ' (Negative)' : ' (Strong Negative)');

            // Sentiment Chart
            var sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
            if (charts.sentiment) {
                charts.sentiment.destroy();
            }

            charts.sentiment = new Chart(sentimentCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Sentiment Score',
                        data: sentiments,
                        borderColor: 'rgba(139, 92, 246, 1)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'rgba(31, 41, 55, 0.9)' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(31, 41, 55, 0.8)' },
                            grid: { color: 'rgba(107, 114, 128, 0.2)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: 'rgba(31, 41, 55, 0.8)' },
                            grid: { color: 'rgba(107, 114, 128, 0.2)' }
                        }
                    }
                }
            });

            // Price Chart
            var priceCtx = document.getElementById('priceChart').getContext('2d');
            if (charts.price) {
                charts.price.destroy();
            }

            charts.price = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'BTC Price',
                        data: prices,
                        borderColor: 'rgba(251, 146, 60, 1)',
                        backgroundColor: 'rgba(251, 146, 60, 0.1)',
                        borderWidth: 2,
                        yAxisID: 'y',
                        fill: false,
                        tension: 0.4
                    }, {
                        label: 'Sentiment Score',
                        data: sentiments,
                        borderColor: 'rgba(139, 92, 246, 1)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        yAxisID: 'y1',
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'rgba(31, 41, 55, 0.9)' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(31, 41, 55, 0.8)' },
                            grid: { color: 'rgba(107, 114, 128, 0.2)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'BTC Price ($)',
                                color: 'rgba(251, 146, 60, 1)'
                            },
                            ticks: { color: 'rgba(251, 146, 60, 0.9)' },
                            grid: { color: 'rgba(107, 114, 128, 0.2)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Sentiment Score',
                                color: 'rgba(139, 92, 246, 1)'
                            },
                            min: 0,
                            max: 100,
                            ticks: { color: 'rgba(139, 92, 246, 0.9)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Initialize
        window.onload = function() {
            updateScores();
            loadDefaultData();
        };
    </script>
</body>
</html>
